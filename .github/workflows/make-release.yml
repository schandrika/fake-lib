name: Deploy Release Artifacts

on:
  workflow_dispatch:
    inputs:
      merge-strategy:
        description: 'Merge strategy and strategy options. Used only in case of merge conflicts'
        required: false
        default: ''
        type: string
      release-version:
        description: 'Version number to use. If provided bump-rule will be ignored'
        required: false
        default: ''
        type: string
      bump-rule:
        description: 'Bump rule for computing next release version number.'
        required: false
        default: 'prerelease'
        type: choice
        options:
          - patch
          - minor
          - major
          - prepatch
          - preminor
          - premajor
          - prerelease
      run-tests-wait:
        description: 'Wait time to run test after merge to main'
        required: false
        default: 600
        type: number
      publish-to-test-pypi:
        description: 'Set to true if you want to publish to https://test.pypi.org/legacy/ instead of pypi.org'
        required: false
        default: true
        type: boolean

defaults:
  run:
    shell: bash

env:
  LANG: en_US.utf-8
  LC_ALL: en_US.utf-8
  PYTHON_VERSION: '3.10'

jobs:
  deploy-release:
    runs-on: ubuntu-22.04
    steps:
      - run: echo "üéâ The job was automatically triggered by a ${{ github.event_name }} event."
      - run: echo "üêß This job is now running on a ${{ runner.os }} server hosted by GitHub!"
      - run: echo "üîé The name of your branch is ${{ github.ref }} and your repository is ${{ github.repository }}."
      #----------------------------------------------
      #       check-out repo and set-up python
      #----------------------------------------------
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: develop

      - name: Do a git merge dry run
        id: merge-dry-run
        run: |
          git config --global user.email "deploy-release-action@pnl.gov"
          git config --global user.name "Deploy Release Github Action"
          git config --add url."git@github.com:".insteadOf "https://github.com/"
          git checkout main
          git merge --no-commit --no-ff develop
        continue-on-error: true

      - name: Abort merge dry-run
        run: |
            if [[ -f .git/MERGE_HEAD ]]; then
              git merge --abort
            fi

      - name: Check if merge had conflicts.
        # if there is conflict and there is no merge strategy set then abort merge and exit
        if: steps.merge-dry-run.outcome != 'success' && github.event.inputs.merge-strategy == ''
        run: |
          echo "merge strategy is ${{ inputs.merge-strategy }}"
          echo "Merge to main has conflicts. Either do a manual merge and release or set input merge-strategy and re-run action"
          exit 1

      - name: Recheckout develop
        run: |
          git checkout develop

      - name: Set up Python ${{ env.PYTHON_VERSION }}
        id: setup-python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      #----------------------------------------------
      #  -----  install & configure poetry  -----
      #----------------------------------------------
      - name: Install Poetry
        uses: snok/install-poetry@v1.3.4
        with:
          virtualenvs-create: true
          virtualenvs-in-project: true
          installer-parallel: true

      #----------------------------------------------
      # install your root project, if required
      #----------------------------------------------
      - name: Install library
        run: |
          poetry lock --no-update
          poetry install --no-interaction 
